#!/bin/sh
# See https://jvns.ca/blog/2023/11/11/notes-on-nix-flakes/

# Problem 2 from the post. Does not apply
# export NIXPKGS_ALLOW_UNFREE=1

install_nix() {
  arch=$(uname -m)
  case "$arch" in
    x86_64) arch="x86_64-linux" ;;
    aarch64|arm64) arch="aarch64-linux" ;;
    *) echo "Unsupported architecture: $arch" >&2; return 1 ;;
  esac

  for version in $(curl -sL https://hydra.nixos.org/project/nix | grep -o 'jobset/nix/[^"]*"' | cut -d/ -f3 | cut -d'"' -f1 | grep -E '^[a-z]+-[0-9]' | sort -Vru); do
    if curl -sL "https://hydra.nixos.org/job/nix/$version/buildStatic.nix-cli.${arch}/latest" | grep -q "Succeeded"; then
      break
    fi
    version=""
  done

  [ -z "$version" ] && echo "Failed to find successful nix build" >&2 && return 1

  url="https://hydra.nixos.org/job/nix/${version}/buildStatic.nix-cli.${arch}/latest/download-by-type/file/binary-dist"

  curl -sL "$url" > "$HOME/.local/bin/nix" && chmod +x "$HOME/.local/bin/nix"
  echo "Installed nix $version (${arch}) to $HOME/.local/bin/nix"
}

if ! command -v nix >/dev/null 2>&1; then
  install_nix || exit 1
fi

if [ -z "$1" ] && [ ! -r "$HOME/.nix-flake/host-config.nix" ]; then
  echo "No arguments specified and no host config, installing only light command line tools"
  echo "to install large packages and those dependent on a window environment"
  echo "use --full. To suppress this message, use --cli"
  echo ""
  echo "To establish host configuration, add a \"host-config.nix\" to $HOME/.nix-flake"
  echo "with contents along this lines of this:"
  echo ""
  echo '{ pkgs ? import <nixpkgs> {} }:'
  echo ''
  echo '{'
  echo '  basePackages = "full"; # Can be "full" or just "" for light command tools'
  echo ''
  echo '  hostPackages = with pkgs; ['
  echo '    # your package list here'
  echo '  ];'
  echo '}'
fi

NIX_CONFIGURE_FULL=0
if [ "$1" = "--full" ]; then
  NIX_CONFIGURE_FULL=1
fi

# This is problem 3 in the post above. Does not currently apply
#rm flake.lock
(cd ~/.nix-flake && NIX_CONFIGURE_FULL=$NIX_CONFIGURE_FULL \
  nix build --impure --out-link ~/.nix-flake/local)
